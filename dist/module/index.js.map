{"version":3,"file":"index.js","sourceRoot":"","sources":["../../src/index.ts"],"names":[],"mappings":"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","sourcesContent":["/* eslint-disable no-var, prefer-rest-params */\n/**\n * Helper used to replace code in a script tag based on a search regex.\n * To inject code without erasing original string, using capturing groups; e.g.\n * ```js\n * inject(/(some string)/,'injected before $1 injected after');\n * ```\n * @param searcher Regex to search and replace\n * @param replacer Replacer string/fn\n */\n function inject(searcher: Parameters<string['replace']>[0] & Parameters<string['search']>[0], replacer: Parameters<string['replace']>[1]) {\n\t// find the relevant script tag\n\tvar scriptTags = document.getElementsByTagName('script');\n\tvar scriptTag: HTMLScriptElement | undefined;\n\tvar code = '';\n\tfor (var i = 0; i < scriptTags.length; ++i) {\n\t\tscriptTag = scriptTags[i];\n\t\tif (!scriptTag.textContent) continue;\n\t\tvar matchesSearch = scriptTag.textContent.search(searcher) !== -1;\n\t\tvar isCurrentScript = scriptTag === document.currentScript;\n\t\tif (matchesSearch && !isCurrentScript) {\n\t\t\tcode = scriptTag.textContent;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\t// error-handling\n\tif (!code || !scriptTag) {\n\t\tthrow new Error('Couldn\\'t find \"' + searcher + '\" in script tags');\n\t}\n\n\t// modify the content\n\tcode = code.replace(searcher, replacer);\n\n\t// replace the old script tag with a new one using our modified code\n\tvar newScriptTag = document.createElement('script');\n\tnewScriptTag.textContent = code;\n\tscriptTag.insertAdjacentElement('afterend', newScriptTag);\n\tscriptTag.remove();\n}\n/**\n * Helper for getting an array with unique elements\n * @param  {Array} array Original array\n * @return {Array}       Copy of array, excluding duplicates\n */\nfunction unique<T>(array: T[]) {\n\treturn array.filter(function (item, idx) {\n\t\treturn array.indexOf(item) === idx;\n\t});\n}\n\n\n// Ex: inject(/(names.sprite.set\\( name, id \\);)/, '$1console.dir(names)');\n/** test */\nfunction kitsyInject(searcher: Parameters<typeof inject>[0], replacer: Parameters<typeof inject>[1]) {\n\tif (\n\t\t!kitsy.queuedInjectScripts.some(function (script) {\n\t\t\treturn searcher.toString() === script.searcher.toString() && replacer === script.replacer;\n\t\t})\n\t) {\n\t\tkitsy.queuedInjectScripts.push({\n\t\t\tsearcher: searcher,\n\t\t\treplacer: replacer,\n\t\t});\n\t} else {\n\t\tconsole.warn('Ignored duplicate inject');\n\t}\n}\n\n// Ex: before('load_game', function run() { alert('Loading!'); });\n//     before('show_text', function run(text) { return text.toUpperCase(); });\n//     before('show_text', function run(text, done) { done(text.toUpperCase()); });\nfunction before(targetFuncName: string, beforeFn: () => void) {\n\tkitsy.queuedBeforeScripts[targetFuncName] = kitsy.queuedBeforeScripts[targetFuncName] || [];\n\tkitsy.queuedBeforeScripts[targetFuncName].push(beforeFn);\n}\n\n// Ex: after('load_game', function run() { alert('Loaded!'); });\nfunction after(targetFuncName: string, afterFn: () => void) {\n\tkitsy.queuedAfterScripts[targetFuncName] = kitsy.queuedAfterScripts[targetFuncName] || [];\n\tkitsy.queuedAfterScripts[targetFuncName].push(afterFn);\n}\n\nfunction applyInjects() {\n\tkitsy.queuedInjectScripts.forEach(function (injectScript) {\n\t\tinject(injectScript.searcher, injectScript.replacer);\n\t});\n}\n\nfunction applyHooks() {\n\tvar allHooks = unique(Object.keys(kitsy.queuedBeforeScripts).concat(Object.keys(kitsy.queuedAfterScripts)));\n\tallHooks.forEach(applyHook);\n}\n\nfunction applyHook(functionName: string) {\n\tvar functionNameSegments = functionName.split('.');\n\tvar obj: any = window;\n\twhile (functionNameSegments.length > 1) {\n\t\tobj = obj[functionNameSegments.shift() as string];\n\t}\n\tvar lastSegment = functionNameSegments[0];\n\tvar superFn = obj[lastSegment];\n\tvar superFnLength = superFn ? superFn.length : 0;\n\tvar functions: typeof kitsy['queuedBeforeScripts'][''] = [];\n\t// start with befores\n\tfunctions = functions.concat(kitsy.queuedBeforeScripts[functionName] || []);\n\t// then original\n\tif (superFn) {\n\t\tfunctions.push(superFn);\n\t}\n\t// then afters\n\tfunctions = functions.concat(kitsy.queuedAfterScripts[functionName] || []);\n\n\t// overwrite original with one which will call each in order\n\tobj[lastSegment] = function () {\n\t\tvar returnVal: never | never[];\n\t\tvar args = [].slice.call(arguments);\n\t\tvar i = 0;\n\n\t\tfunction runBefore(this: any): unknown {\n\t\t\t// All outta functions? Finish\n\t\t\tif (i === functions.length) {\n\t\t\t\treturn returnVal;\n\t\t\t}\n\n\t\t\t// Update args if provided.\n\t\t\tif (arguments.length > 0) {\n\t\t\t\targs = [].slice.call(arguments);\n\t\t\t}\n\n\t\t\tif (functions[i].length > superFnLength) {\n\t\t\t\t// Assume funcs that accept more args than the original are\n\t\t\t\t// async and accept a callback as an additional argument.\n\t\t\t\treturn functions[i++].apply(this, args.concat(runBefore.bind(this) as never));\n\t\t\t}\n\t\t\t// run synchronously\n\t\t\treturnVal = functions[i++].apply(this, args) as never | never[];\n\t\t\tif (returnVal && returnVal.length) {\n\t\t\t\targs = returnVal;\n\t\t\t}\n\t\t\treturn runBefore.apply(this, args as []);\n\t\t}\n\n\t\treturn runBefore.apply(this, arguments as unknown as []);\n\t};\n}\n\ninterface Kitsy {\n\tqueuedInjectScripts: { searcher: Parameters<typeof kitsyInject>[0]; replacer: Parameters<typeof kitsyInject>[1] }[];\n\tqueuedBeforeScripts: Record<string, ((...args: unknown[]) => unknown)[]>;\n\tqueuedAfterScripts: Record<string, ((...args: unknown[]) => unknown)[]>;\n\tinject: typeof kitsyInject;\n\tbefore: typeof before;\n\tafter: typeof after;\n\tapplyInjects: typeof applyInjects;\n\tapplyHooks: typeof applyHooks;\n}\n\n/**\n@file kitsy-script-toolkit\n@summary Monkey-patching toolkit to make it easier and cleaner to run code before and after functions or to inject new code into script tags\n@license WTFPL (do WTF you want)\n@author Original by mildmojo; modified by Sean S. LeBlanc\n*/\nexport var kitsy: Kitsy = ((window as { kitsy?: Kitsy }).kitsy = (window as { kitsy?: Kitsy }).kitsy || {\n\tqueuedInjectScripts: [],\n\tqueuedBeforeScripts: {},\n\tqueuedAfterScripts: {},\n\tinject: kitsyInject,\n\tbefore,\n\tafter,\n\t/**\n\t * Applies all queued `inject` calls.\n\t *\n\t * An object that instantiates an class modified via injection will still refer to the original class,\n\t * so make sure to reinitialize globals that refer to injected scripts before calling `applyHooks`.\n\t */\n\tapplyInjects,\n\t/** Apples all queued `before`/`after` calls. */\n\tapplyHooks,\n});\n"]}